<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | ITRACK ระบบติดตามงานวิจัย</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&family=Sarabun:wght@300;400;600&display=swap');
        
        html, body { height: 100%; font-family: 'Sarabun', sans-serif; background-color: #f8fafc; color: #1e293b; }
        h1, h2, h3, h4, h5, .navbar-brand, .btn, .nav-link { font-family: 'Prompt', sans-serif; }
        
        .navbar { background: #1e293b !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .navbar-brand { letter-spacing: 1px; font-weight: 700; }

        .loader-overlay { position: fixed; inset: 0; background: white; display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity .25s ease; }
        .loader-overlay.hide { opacity:0; pointer-events:none; }

        .card { border: none; border-radius: 16px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        .filter-card { background: white; padding: 20px; margin-bottom: 25px; }
        
        .table { margin-bottom: 0; }
        .table thead th { background: #f8fafc; font-size: 0.85rem; text-transform: uppercase; color: #64748b; padding: 15px; border-top: none; }
        .table tbody td { padding: 15px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }
        
        .project-title-th { font-weight: 600; color: #1e293b; display: block; line-height: 1.4; }
        .project-title-en { font-size: 0.8rem; color: #64748b; font-style: italic; display: block; line-height: 1.4; }
        
        .badge { border-radius: 8px; padding: 6px 12px; font-weight: 500; font-size: 0.75rem; }
        .bg-soft-success { background: #dcfce7; color: #15803d; }
        .bg-soft-warning { background: #fef9c3; color: #854d0e; }
        .bg-soft-danger { background: #fee2e2; color: #b91c1c; }
        .bg-soft-secondary { background: #f1f5f9; color: #475569; }

        .btn-action { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; }
    </style>
</head>

<body>

<div id="page-loader" class="loader-overlay">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2 fw-bold text-secondary">กำลังโหลดข้อมูล...</div>
    </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark py-3">
    <div class="container">
        <a class="navbar-brand fs-4" href="{{ url_for('research.landing') }}">ITRACK</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('research.landing') }}">
                        <i class="bi bi-house-door-fill me-1"></i> หน้าหลัก
                    </a>
                </li>
                
                <li class="nav-item ms-lg-3">
                    <div class="d-flex align-items-center text-white-50 bg-white bg-opacity-10 px-3 py-1 rounded-pill">
                        <i class="bi bi-person-circle me-2"></i>
                        <span class="small me-3">{{ current_user.username }}</span>
                        <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-danger rounded-circle p-0 d-flex align-items-center justify-content-center" style="width: 24px; height: 24px;" title="ออกจากระบบ">
                            <i class="bi bi-power" style="font-size: 0.8rem;"></i>
                        </a>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-4">

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="d-flex justify-content-between align-items-end mb-4">
    <div>
        <h3 class="fw-bold mb-1">ระบบจัดการโครงการวิจัย</h3>
        <p class="text-muted mb-0 small">ติดตามสถานะและตรวจสอบข้อมูลงานวิจัยทั้งหมดในระบบ</p>
    </div>
    
    <form action="{{ url_for('research.clear_all') }}" method="POST" onsubmit="return confirm('คุณต้องการลบข้อมูลโครงการทั้งหมดใช่หรือไม่?')">
        <button class="btn btn-outline-danger btn-sm px-3 fw-bold rounded-pill">
            <i class="bi bi-trash3 me-1"></i> ล้างข้อมูลทั้งหมด
        </button>
    </form>
</div>

<div class="card filter-card shadow-sm">
    <form method="GET" class="row g-3">
        <div class="col-md-4">
            <label class="form-label small fw-bold text-secondary">ค้นหาข้อมูล</label>
            <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="bi bi-search text-muted"></i></span>
                <input class="form-control bg-light border-0" name="q" placeholder="ชื่อโครงการ / นักวิจัย / สังกัด..." value="{{ q }}">
            </div>
        </div>

        <div class="col-md-3">
            <label class="form-label small fw-bold text-secondary">หน่วยงาน/สังกัด</label>
            <select class="form-select bg-light border-0" name="aff">
                <option value="">-- ทั้งหมด --</option>
                {% for a in aff_list %}
                    <option value="{{ a }}" {% if a==aff_filter %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label small fw-bold text-secondary">สถานะโครงการ</label>
            <select class="form-select bg-light border-0" name="status">
                <option value="">-- ทุกสถานะ --</option>
                {% for s in ['On Track', 'Near Deadline', 'Overdue'] %}
                    <option {% if status_filter==s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2 d-grid align-items-end">
            <button class="btn btn-primary fw-bold py-2 shadow-sm">กรองข้อมูล</button>
        </div>
    </form>
</div>

<div class="mb-3 ps-1">
    <span class="text-muted small">พบข้อมูลโครงการทั้งหมด <strong>{{ total }}</strong> รายการ</span>
</div>

<div class="card shadow-sm overflow-hidden">
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th style="width: 22%;">ชื่อโครงการ (ไทย)</th>
                    <th style="width: 22%;">ชื่อโครงการ (English)</th>
                    <th>ผู้รับผิดชอบ</th>
                    <th>สังกัด</th>
                    <th>วันที่เริ่มโครงการ</th>
                    <th>วันที่สิ้นสุดโครงการ</th>
                    <th>งบประมาณ</th>
                    <th>กำหนดส่ง</th>
                    <th class="text-center">สถานะ</th>
                    <th class="text-end">จัดการ</th>
                </tr>
            </thead>
            <tbody>
                {% for p in projects %}
                <tr>
                    <td><span class="project-title-th">{{ p.project_th }}</span></td>
                    <td><span class="project-title-en text-muted">{{ p.project_en if p.project_en else '-' }}</span></td>
                    <td class="small"><i class="bi bi-person-circle me-1 text-muted"></i> {{ p.researcher_name }}</td>
                    <td><span class="badge bg-light text-dark border fw-normal">{{ p.affiliation }}</span></td>
                    <td class="small text-muted">{{ p.start_date if p.start_date else '-' }}</td>
                    <td class="small text-muted">{{ p.end_date if p.end_date else '-' }}</td>
                    <td class="fw-bold text-primary">{{ "{:,.0f}".format(p.funding) if p.funding and p.funding > 0 else '-' }}</td>
                    <td class="small text-muted">{{ p.deadline }}</td>
                    <td class="text-center"><span class="badge bg-soft-secondary">{{ p.status_text }}</span></td>
                    <td class="text-end">
                        <div class="d-flex justify-content-end gap-1">
                            <form method="POST" action="{{ url_for('research.send_project_alert', pid=p.id) }}">
                                <button class="btn btn-warning btn-action text-white"><i class="bi bi-envelope-fill"></i></button>
                            </form>
                            <form method="POST" action="{{ url_for('research.delete_project', pid=p.id) }}">
                                <button class="btn btn-light btn-action text-danger"><i class="bi bi-trash"></i></button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

</div>

<script>
const loader = document.getElementById("page-loader");
window.addEventListener("load", () => setTimeout(() => loader.classList.add("hide"), 300));
</script>

</body>
</html>
