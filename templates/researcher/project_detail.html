{% extends "base_researcher.html" %}

{% block title %}{{ project.project_th }} | ITRACK{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Back Button -->
    <div class="mb-3">
        <a href="{{ url_for('researcher.dashboard') }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-2"></i>กลับไปโครงการของฉัน
        </a>
    </div>

    <!-- Project Info Card -->
    <div class="content-card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>ข้อมูลโครงการ</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h3 class="mb-2">{{ project.project_th }}</h3>
                    {% if project.project_en %}
                    <p class="text-muted mb-3">{{ project.project_en }}</p>
                    {% endif %}

                    <div class="mb-2">
                        <strong>ผู้วิจัย:</strong> {{ project.researcher_name }}
                    </div>
                    <div class="mb-2">
                        <strong>สังกัด:</strong> {{ project.affiliation or '-' }}
                    </div>
                    {% if project.funding %}
                    <div class="mb-2">
                        <strong>งบประมาณ:</strong> {{ "{:,.0f}".format(project.funding) }} บาท
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {% if project.start_date %}
                    <div class="mb-2">
                        <strong>วันเริ่ม:</strong> {{ project.start_date }}
                    </div>
                    {% endif %}
                    {% if project.end_date %}
                    <div class="mb-2">
                        <strong>วันสิ้นสุด:</strong> {{ project.end_date }}
                    </div>
                    {% endif %}
                    {% if project.deadline %}
                    <div class="mb-2">
                        <strong>Deadline:</strong> <span class="text-danger">{{ project.deadline }}</span>
                    </div>
                    {% endif %}

                    <!-- Current Progress -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <strong>ความคืบหน้าปัจจุบัน:</strong>
                            <span class="text-primary fw-bold">{{ project.progress_percent }}%</span>
                        </div>
                        <div class="progress" style="height: 12px;">
                            {% if project.progress_percent <= 25 %} <div class="progress-bar bg-danger"
                                style="width: {{ project.progress_percent }}%">
                        </div>
                        {% elif project.progress_percent <= 50 %} <div class="progress-bar bg-warning"
                            style="width: {{ project.progress_percent }}%">
                    </div>
                    {% elif project.progress_percent <= 75 %} <div class="progress-bar bg-info"
                        style="width: {{ project.progress_percent }}%">
                </div>
                {% else %}
                <div class="progress-bar bg-success" style="width: {{ project.progress_percent }}%"></div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>
</div>

<div class="row g-4">
    <!-- Update Progress Form -->
    <div class="col-lg-6">
        <div class="content-card">
            <div class="card-header bg-primary">
                <h5 class="mb-0 text-white">
                    <i class="bi bi-pencil-square me-2"></i>อัปเดตความคืบหน้า
                </h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('researcher.update_progress', project_id=project.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <!-- Progress Percentage -->
                    <div class="mb-3">
                        <label class="form-label">
                            ความคืบหน้า (%) <span class="text-danger">*</span>
                        </label>
                        <select class="form-select form-select-lg" name="progress_percent" id="progressSelect" required>
                            <option value="0" {% if project.progress_percent==0 %}selected{% endif %}>0% - ยังไม่เริ่ม
                            </option>
                            <option value="10" {% if project.progress_percent==10 %}selected{% endif %}>10% - เริ่มต้น
                            </option>
                            <option value="25" {% if project.progress_percent==25 %}selected{% endif %}>25% -
                                กำลังดำเนินการ</option>
                            <option value="50" {% if project.progress_percent==50 %}selected{% endif %}>50% - ครึ่งทาง
                            </option>
                            <option value="75" {% if project.progress_percent==75 %}selected{% endif %}>75% - ใกล้เสร็จ
                            </option>
                            <option value="90" {% if project.progress_percent==90 %}selected{% endif %}>90% -
                                ตรวจสอบขั้นสุดท้าย</option>
                            <option value="100" {% if project.progress_percent==100 %}selected{% endif %}>100% -
                                เสร็จสมบูรณ์</option>
                        </select>
                    </div>

                    <!-- Status -->
                    <div class="mb-3">
                        <label class="form-label">
                            สถานะ <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" name="status" id="statusSelect" required
                            onchange="toggleDelayReason()">
                            <option value="not_started" {% if project.current_status=='not_started' %}selected{% endif
                                %}>
                                ยังไม่เริ่ม
                            </option>
                            <option value="in_progress" {% if project.current_status=='in_progress' %}selected{% endif
                                %}>
                                กำลังดำเนินการ
                            </option>
                            <option value="completed" {% if project.current_status=='completed' %}selected{% endif %}>
                                เสร็จสมบูรณ์
                            </option>
                            <option value="on_hold" {% if project.current_status=='on_hold' %}selected{% endif %}>
                                หยุดชั่วคราว
                            </option>
                            <option value="delayed" {% if project.current_status=='delayed' %}selected{% endif %}>
                                ล่าช้า
                            </option>
                        </select>
                    </div>

                    <!-- Delay Reason (shown only if status = delayed) -->
                    <div class="mb-3" id="delayReasonDiv" style="display: none;">
                        <label class="form-label">
                            เหตุผลความล่าช้า <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" name="delay_reason" rows="3"
                            placeholder="กรุณาระบุเหตุผลที่โครงการล่าช้า..."></textarea>
                    </div>

                    <!-- Remarks -->
                    <div class="mb-3">
                        <label class="form-label">หมายเหตุ / ความคืบหน้ารายละเอียด</label>
                        <textarea class="form-control" name="remarks" rows="4"
                            placeholder="ระบุรายละเอียดความคืบหน้า, ปัญหาที่พบ, หรือข้อเสนอแนะ..."></textarea>
                    </div>

                    <!-- Submit -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>บันทึกการอัปเดต
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Update History -->
    <div class="col-lg-6">
        <div class="content-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>ประวัติการอัปเดต
                </h5>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                {% if updates %}
                <div class="timeline">
                    {% for update in updates %}
                    <div class="timeline-item mb-3 pb-3" style="border-bottom: 1px solid var(--border-light);">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>{{ update.username }}</strong>
                                <span class="text-muted ms-2">{{ update.updated_at }}</span>
                            </div>
                            <div>
                                {% if update.status == 'completed' %}
                                <span class="badge bg-success">เสร็จสมบูรณ์</span>
                                {% elif update.status == 'delayed' %}
                                <span class="badge bg-danger">ล่าช้า</span>
                                {% elif update.status == 'in_progress' %}
                                <span class="badge bg-primary">กำลังดำเนินการ</span>
                                {% elif update.status == 'on_hold' %}
                                <span class="badge bg-warning">หยุดชั่วคราว</span>
                                {% else %}
                                <span class="badge bg-secondary">ยังไม่เริ่ม</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="mb-2">
                            <small class="text-muted">ความคืบหน้า:</small>
                            <strong class="text-primary ms-2">{{ update.progress_percent }}%</strong>
                        </div>

                        <!-- Remarks -->
                        {% if update.remarks %}
                        <div class="mb-2">
                            <small class="text-muted">หมายเหตุ:</small>
                            <p class="mb-0 mt-1 ps-3" style="border-left: 3px solid var(--primary-500);">
                                {{ update.remarks }}
                            </p>
                        </div>
                        {% endif %}

                        <!-- Delay Reason -->
                        {% if update.delay_reason %}
                        <div class="alert alert-warning mb-0 mt-2" role="alert">
                            <strong><i class="bi bi-exclamation-triangle me-2"></i>เหตุผลความล่าช้า:</strong>
                            <p class="mb-0 mt-1">{{ update.delay_reason }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-2">ยังไม่มีประวัติการอัปเดต</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>

<script>
    function toggleDelayReason() {
        const status = document.getElementById('statusSelect').value;
        const delayDiv = document.getElementById('delayReasonDiv');

        if (status === 'delayed') {
            delayDiv.style.display = 'block';
            delayDiv.querySelector('textarea').required = true;
        } else {
            delayDiv.style.display = 'none';
            delayDiv.querySelector('textarea').required = false;
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        toggleDelayReason();
    });
</script>
{% endblock %}